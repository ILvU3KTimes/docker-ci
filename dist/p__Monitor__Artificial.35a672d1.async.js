(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[24],{"/Lqm":function(t,e,n){"use strict";n.r(e);n("+L6B");var a=n("2/Rp"),i=(n("miYZ"),n("tsqr")),o=(n("OaEy"),n("2fM7")),r=(n("g9YV"),n("wCAj")),s=(n("14J3"),n("BMrR")),l=(n("R9oj"),n("ECub")),c=(n("jCWc"),n("kPKH")),d=(n("IzEo"),n("bx4M")),u=(n("Pwec"),n("CtXQ")),p=(n("Awhp"),n("KrTs")),h=n("gWZ8"),m=n.n(h),f=n("2Taf"),y=n.n(f),v=n("vZ4D"),g=n.n(v),x=n("l4Ni"),w=n.n(x),E=n("ujKo"),b=n.n(E),k=n("MhPg"),P=n.n(k),I=(n("y8nQ"),n("Vl3Y")),C=(n("2qtc"),n("kLXV")),O=n("q1tI"),T=n.n(O),L=n("LLXN"),B=n("MuoO"),S=n("Dvey"),N=n("sutq"),M=n("+n12"),R=n("34ay"),j=(n("T+dw"),n("ZFw/")),A=n.n(j),V=n("4/k0"),U=n.n(V),_=n("wHMd"),D={Player:null,VideoElement:null,CreateVideoElements:function(){for(var t=document.querySelectorAll(".jswebrtc"),e=0;e<t.length;e++)new D.VideoElement(t[e])},FillQuery:function(t,e){if(e.user_query={},0!=t.length){t.indexOf("?")>=0&&(t=t.split("?")[1]);for(var n=t.split("&"),a=0;a<n.length;a++){var i=n[a].split("=");e[i[0]]=i[1],e.user_query[i[0]]=i[1]}e.domain&&(e.vhost=e.domain)}},ParseUrl:function(t){var e=document.createElement("a");e.href=t.replace("rtmp://","http://").replace("webrtc://","http://").replace("rtc://","http://");var n=e.hostname,a=e.pathname.substr(1,e.pathname.lastIndexOf("/")-1),i=e.pathname.substr(e.pathname.lastIndexOf("/")+1);if(a=a.replace("...vhost...","?vhost="),a.indexOf("?")>=0){var o=a.substr(a.indexOf("?"));a=a.substr(0,a.indexOf("?")),o.indexOf("vhost=")>0&&(n=o.substr(o.indexOf("vhost=")+"vhost=".length),n.indexOf("&")>0&&(n=n.substr(0,n.indexOf("&"))))}if(e.hostname==n){var r=/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/;r.test(e.hostname)&&(n="__defaultVhost__")}var s="rtmp";t.indexOf("://")>0&&(s=t.substr(0,t.indexOf("://")));var l=e.port;l||("http"===s?l=80:"https"===s?l=443:"rtmp"===s?l=1935:"webrtc"!==s&&"rtc"!==s||(l=1985));var c={url:t,schema:s,server:e.hostname,port:l,vhost:n,app:a,stream:i};return D.FillQuery(e.search,c),c},HttpPost:function(t,e){return new Promise(function(n,a){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState&&i.status>=200&&i.status<300){var t=JSON.parse(i.responseText);i.onreadystatechange=new Function,i=null,n(t)}},i.open("POST",t,!0),i.timeout=5e3,i.responseType="text",i.setRequestHeader("Content-Type","application/json"),i.send(e)})}};"complete"===document.readyState?D.CreateVideoElements():document.addEventListener("DOMContentLoaded",D.CreateVideoElements),D.VideoElement=function(){var t=function(e){var n=e.dataset.url;if(!n)throw"VideoElement has no `data-url` attribute";var a=function(t,e){for(var n in e)t.style[n]=e[n]};this.container=e,a(this.container,{display:"inline-block",position:"relative",minWidth:"80px",minHeight:"80px"}),this.video=document.createElement("video"),this.video.width=960,this.video.height=540,a(this.video,{display:"block",width:"100%"}),this.container.appendChild(this.video),this.playButton=document.createElement("div"),this.playButton.innerHTML=t.PLAY_BUTTON,a(this.playButton,{zIndex:2,position:"absolute",top:"0",bottom:"0",left:"0",right:"0",maxWidth:"75px",maxHeight:"75px",margin:"auto",opacity:"0.7",cursor:"pointer"}),this.container.appendChild(this.playButton);var i={video:this.video};for(var o in e.dataset)try{i[o]=JSON.parse(e.dataset[o])}catch(t){i[o]=e.dataset[o]}if(this.player=new D.Player(n,i),e.playerInstance=this.player,i.poster&&!i.autoplay&&(i.decodeFirstFrame=!1,this.poster=new Image,this.poster.src=i.poster,this.poster.addEventListener("load",this.posterLoaded),a(this.poster,{display:"block",zIndex:1,position:"absolute",top:0,left:0,bottom:0,right:0}),this.container.appendChild(this.poster)),this.player.options.streaming||this.container.addEventListener("click",this.onClick.bind(this)),i.autoplay&&(this.playButton.style.display="none"),this.player.audioOut&&!this.player.audioOut.unlocked){var r=this.container;i.autoplay&&(this.unmuteButton=document.createElement("div"),this.unmuteButton.innerHTML=t.UNMUTE_BUTTON,a(this.unmuteButton,{zIndex:2,position:"absolute",bottom:"10px",right:"20px",width:"75px",height:"75px",margin:"auto",opacity:"0.7",cursor:"pointer"}),this.container.appendChild(this.unmuteButton),r=this.unmuteButton),this.unlockAudioBound=this.onUnlockAudio.bind(this,r),r.addEventListener("touchstart",this.unlockAudioBound,!1),r.addEventListener("click",this.unlockAudioBound,!0)}};return t.prototype.onUnlockAudio=function(t,e){this.unmuteButton&&(e.preventDefault(),e.stopPropagation()),this.player.audioOut.unlock(function(){this.unmuteButton&&(this.unmuteButton.style.display="none"),t.removeEventListener("touchstart",this.unlockAudioBound),t.removeEventListener("click",this.unlockAudioBound)}.bind(this))},t.prototype.onClick=function(t){this.player.isPlaying?(this.player.pause(),this.playButton.style.display="block"):(this.player.play(),this.playButton.style.display="none",this.poster&&(this.poster.style.display="none"))},t.PLAY_BUTTON='<svg style="max-width: 75px; max-height: 75px;" viewBox="0 0 200 200" alt="Play video"><circle cx="100" cy="100" r="90" fill="none" stroke-width="15" stroke="#fff"/><polygon points="70, 55 70, 145 145, 100" fill="#fff"/></svg>',t.UNMUTE_BUTTON='<svg style="max-width: 75px; max-height: 75px;" viewBox="0 0 75 75"><polygon class="audio-speaker" stroke="none" fill="#fff" points="39,13 22,28 6,28 6,47 21,47 39,62 39,13"/><g stroke="#fff" stroke-width="5"><path d="M 49,50 69,26"/><path d="M 69,50 49,26"/></g></svg>',t}(),D.Player=function(){var t=function(t,e){if(this.options=e||{},!t.match(/^webrtc?:\/\//))throw"JSWebrtc just work with webrtc";if(!this.options.video)throw"VideoElement is null";this.urlParams=D.ParseUrl(t),this.pc=null,this.autoplay=!!e.autoplay||!1,this.paused=!0,this.autoplay&&(this.options.video.muted=!0),this.startLoading()};return t.prototype.startLoading=function(){var t=this;t.pc&&t.pc.close(),t.pc=new RTCPeerConnection(null),t.pc.ontrack=function(e){t.options.video["srcObject"]=e.streams[0]},t.pc.addTransceiver("audio",{direction:"recvonly"}),t.pc.addTransceiver("video",{direction:"recvonly"}),t.pc.createOffer().then(function(e){return t.pc.setLocalDescription(e).then(function(){return e})}).then(function(e){return new Promise(function(n,a){var i=t.urlParams.port||1985,o=t.urlParams.user_query.play||"/rtc/v1/play/";o.lastIndexOf("/")!=o.length-1&&(o+="/");var r="http://"+t.urlParams.server+":"+i+o;for(var s in t.urlParams.user_query)"api"!=s&&"play"!=s&&(r+="&"+s+"="+t.urlParams.user_query[s]);var l={api:r,streamurl:t.urlParams.url,clientip:null,sdp:e.sdp};console.log("offer: "+JSON.stringify(l)),D.HttpPost(r,JSON.stringify(l)).then(function(t){console.log("answer: "+JSON.stringify(t)),n(t.sdp)},function(t){a(t)})})}).then(function(e){if(e)return t.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e}))}).catch(function(t){throw t}),this.autoplay&&this.play()},t.prototype.play=function(t){this.animationId||(this.animationId=requestAnimationFrame(this.update.bind(this)),this.paused=!1)},t.prototype.pause=function(t){this.paused||(cancelAnimationFrame(this.animationId),this.animationId=null,this.isPlaying=!1,this.paused=!0,this.options.video.pause(),this.options.onPause&&this.options.onPause(this))},t.prototype.stop=function(t){this.pause()},t.prototype.destroy=function(){this.pause(),this.pc&&this.pc.close()&&this.pc.destroy(),this.audioOut&&this.audioOut.destroy()},t.prototype.update=function(){this.animationId=requestAnimationFrame(this.update.bind(this)),this.options.video.readyState<4||this.isPlaying||(this.isPlaying=!0,this.options.video.play(),this.options.onPlay&&this.options.onPlay(this))},t}();var q=D,H=n("0jGE"),W=n.n(H);function F(t,e,n){return e=b()(e),w()(t,J()?Reflect.construct(e,n||[],b()(t).constructor):e.apply(t,n))}function J(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(J=function(){return!!t})()}var z,Y,G,K=function(t){function e(t){var n;y()(this,e),n=F(this,e,[t]),n.onPicSave=function(){var t=n.props,e=t.blockWidth,a=t.blockHeight,i=document.createElement("canvas"),o=document.getElementById(n.videoEleId);i.width=e,i.height=a,i.getContext("2d").drawImage(o,0,0,i.width,i.height);var r=document.createElement("a");r.href=i.toDataURL("image/png"),r.download="screenshot-".concat((new Date).getTime()),r.click()};var a=n.props.item.id;return n.RTCPlayer=null,n.videoEleId="video-webrtc-".concat(a),n}return P()(e,t),g()(e,[{key:"componentDidMount",value:function(){var t=this.props.item.playAddress,e=document.getElementById(this.videoEleId);this.RTCPlayer=new q.Player(t,{video:e,autoplay:!0,onPlay:function(){console.log("start play")},onPause:function(){console.log("pause")}})}},{key:"componentWillUnmount",value:function(){this.RTCPlayer&&this.RTCPlayer.destroy()}},{key:"render",value:function(){var t=this.props,e=t.width,n=t.height,a=t.hiddenSS,i={position:"absolute",top:"4px",right:"35px",fontSize:"20px",color:"#fff",cursor:"pointer"};return T.a.createElement("div",{style:{width:"100%",height:"100%"}},T.a.createElement("video",{className:W.a.rtcPlayer,id:this.videoEleId,controls:!0,width:e,height:n}),a?null:T.a.createElement(u["a"],{type:"picture",title:"\u622a\u56fe",style:i,onClick:this.onPicSave}))}}])}(O["PureComponent"]),Q=K,X=n("Py4S"),Z=n.n(X);function $(t,e,n){return e=b()(e),w()(t,tt()?Reflect.construct(e,n||[],b()(t).constructor):e.apply(t,n))}function tt(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(tt=function(){return!!t})()}var et=C["a"].confirm,nt=(z=I["a"].create(),Y=Object(B["connect"])(function(t){var e=t.artificial,n=t.user;return{artificial:e,user:n}}),z(G=Y(G=function(t){function e(t){var n;return y()(this,e),n=$(this,e,[t]),n.wsUpdateData=function(){n.props.dispatch;var t=Object(M["j"])(!1,5),e="ws://192.168.1.99:8082/daihai/ws/meter/".concat(Object(R["c"])().tenant_id,"/").concat(Object(R["c"])().name,"/").concat(t);console.log("wsUrl",e),N["a"].initConnection(e,function(t){if(console.log("WebSocket Message",t),void 0!==t.status&&n.setState({status:t.status}),t.log){t.log.animation=!1;var e=n.state.eventLog;e.forEach(function(t){Object.keys(t).includes("animation")&&delete t.animation});var a=m()(e);a.unshift(t.log),n.setState({eventLog:a})}if(t.meterReading){var i=n.state.data,o=m()(i);o.unshift(t.meterReading),n.setState({data:o})}})},n.deleteEventLog=function(t){var e=n.state.eventLog,a=e.filter(function(e){return e.eventId!==t});n.setState({eventLog:a})},n.closePlayer=function(t){et({title:"\u5173\u95ed\u786e\u8ba4",content:"\u786e\u5b9a\u5173\u95ed\u8be5\u64ad\u653e\u5668\u5417\uff1f",okText:"\u786e\u5b9a",okType:"danger",cancelText:"\u53d6\u6d88",onOk:function(){var e=n.state.playArr,a=e.filter(function(e){return e.id!==t});n.setState({playArr:a})}})},n.exit=function(){var t=n.props.dispatch;C["a"].confirm({title:"\u9000\u51fa\u786e\u8ba4",content:"\u662f\u5426\u786e\u5b9a\u9000\u51fa\u767b\u5f55\uff1f",okText:"\u786e\u5b9a",okType:"danger",cancelText:"\u53d6\u6d88",onOk:function(){t({type:"login/logout"})},onCancel:function(){}})},n.handleLogClick=function(t){var e=n.props.dispatch;n.setState({visible:!0,fetchStream:!1,logInfo:t}),e({type:"eventMonitor/getBehaviorLog",payload:{eventId:t.eventId}}).then(function(){n.setState({fetchStream:!0})})},n.handleCancel=function(){n.setState({visible:!1})},n.columns=[{title:"\u6444\u50cf\u5934",dataIndex:"deviceName",align:"center",render:function(t){return t||"-"}},{title:"\u4eea\u8868\u540d\u79f0",dataIndex:"cabinetName",align:"center",render:function(t){return t||"-"}},{title:"\u4eea\u8868\u7c7b\u578b",dataIndex:"cabinetType",align:"center",render:function(t){return t||"-"}},{title:"\u4eea\u8868\u7f16\u53f7",dataIndex:"cabinetCode",align:"center",render:function(t){return t||"-"}},{title:"\u9884\u5236\u70b9\u4f4d",dataIndex:"pointCode",align:"center",render:function(t){return t||"-"}},{title:"\u5de1\u68c0\u65f6\u95f4",dataIndex:"inspectionTime",align:"center",render:function(t){return t||"-"}},{title:"\u6240\u5c5e\u533a\u57df",dataIndex:"regionName",align:"center",render:function(t){return t||"-"}},{title:"\u4eea\u8868\u7167\u7247",dataIndex:"meterPhoto",align:"center",render:function(t){return t?T.a.createElement(Z.a,{controller:{close:!0,zoom:!1,download:!0,rotate:!0,flip:!1,pagination:!1},style:{width:"100px",height:"auto"},src:t}):"-"}},{title:"\u4eea\u8868\u8bfb\u6570",dataIndex:"readingResult",align:"center",width:"200px",ellipsis:!0,render:function(t){return t?"\u4eea\u8868".concat(Object.keys(t)[0],"\uff1a").concat(Object.values(t)[0]):"-"}},{title:"\u5de1\u68c0\u7c7b\u578b",dataIndex:"planType",align:"center",render:function(t){return t&&"0"===t?"\u81ea\u52a8\u5de1\u68c0":"\u4eba\u5de5\u5de1\u68c0"}},{title:"\u72b6\u6001",dataIndex:"status",align:"center",render:function(t){return T.a.createElement(p["a"],{status:"0"===t?"success":"warning",text:"0"===t?"\u6b63\u5e38":"\u62a5\u8b66"})}}],n.state={playArr:[],visible:!1,fetchStream:!1,logInfo:{},eventLog:[],id:void 0,status:!1,data:[]},n.boundary={maxPlayerNum:16},n}return P()(e,t),g()(e,[{key:"componentDidMount",value:function(){var t=this,e=this.props.dispatch;e({type:"user/fetchCurrent"}),e({type:"artificial/getList"}),e({type:"artificial/status"}).then(function(e){return t.setState({status:e})}),this.wsUpdateData()}},{key:"componentWillUnmount",value:function(){N["a"].destroyResources()}},{key:"render",value:function(){var t=this,e=this.state,n=e.playArr,p=e.visible,h=e.fetchStream,m=e.logInfo,f=this.props,y=f.user.currentUser,v=void 0===y?{}:y,g=f.artificial.list,x=Object(M["a"])();return T.a.createElement(A.a,{title:window.monitorTitle},T.a.createElement("div",{className:U.a.container},T.a.createElement("div",{id:"blockView",className:"".concat(U.a.blockView," ").concat(n&&n.length>0?"":U.a.emptyBlockView)},T.a.createElement(s["a"],{gutter:[1,1]},n&&n.length>0?n.map(function(e){var a=document.getElementById("blockView"),i=a.clientWidth,o=Math.round(n.length>9?i/4:n.length>4?i/3:n.length>1?i/2:i),r=Math.round(1080*o/1920);return T.a.createElement(c["a"],{span:n.length>9?6:n.length>4?8:n.length>1?12:24,key:e.deviceId},T.a.createElement(d["a"],{type:"inner",title:e.deviceName,className:U.a.playerCard,headStyle:{minHeight:0,padding:"5px",backgroundColor:"rgb(23 62 161)",color:"#fff"},bodyStyle:{padding:0},extra:T.a.createElement(u["a"],{type:"close-circle",theme:"twoTone",className:U.a.closeIcon,twoToneColor:"#f5222d",onClick:function(){return t.closePlayer(e.id)}})},x?T.a.createElement(Q,{item:e,width:o,height:r,blockWidth:i,blockHeight:a.clientHeight}):T.a.createElement("span",null,Object(L["formatMessage"])({id:"eventMonitor.browserDetect"}))))}):T.a.createElement(l["a"],{image:l["a"].PRESENTED_IMAGE_SIMPLE,description:"\u6682\u65e0\u753b\u9762",style:{color:"#fff"}}))),T.a.createElement("div",{className:U.a.header},T.a.createElement("span",{className:U.a.theTitle},window.monitorTitle),T.a.createElement("div",{className:U.a.personCenter,onClick:function(){t.exit()}},T.a.createElement("div",{className:U.a.image}),T.a.createElement("div",{className:U.a.name},v.name),T.a.createElement("div",{className:U.a.exit}))),T.a.createElement("div",{className:U.a.block},T.a.createElement("div",{className:U.a.rightBlock},T.a.createElement(S["c"],{title:Object(L["formatMessage"])({id:"eventMonitor.EventList"}),style:{height:"100%",width:"100%"}},T.a.createElement("div",{style:{height:"calc(100% - 32px)",overflowY:"auto"}},this.state.eventLog.length>0?this.state.eventLog.map(function(e){return T.a.createElement(S["b"],{data:e,key:e&&e.eventId,onRef:function(){return t.handleLogClick(e)}})}):T.a.createElement(l["a"],{image:l["a"].PRESENTED_IMAGE_SIMPLE,style:{color:"#fff"}})))),T.a.createElement("div",{className:U.a.underTable},T.a.createElement(r["a"],{columns:this.columns,dataSource:this.state.data,pagination:!1,size:"small",rowKey:"readingId",bordered:!1})),T.a.createElement("div",{style:{marginTop:"-30px",marginLeft:"10px",pointerEvents:"auto"}},T.a.createElement(o["a"],{showSearch:!0,style:{width:250},placeholder:"\u8bf7\u9009\u62e9\u5de1\u68c0\u8ba1\u5212",optionFilterProp:"children",onChange:function(e){return t.setState({id:e})},filterOption:function(t,e){return e.props.children.toLowerCase().indexOf(t.toLowerCase())>=0},disabled:!this.state.status},g.map(function(t){return T.a.createElement(o["a"].Option,{key:t.planId,value:t.planId},t.planName)})),T.a.createElement(a["a"],{type:this.state.status?"primary":"danger",style:{marginLeft:"18px"},onClick:function(){var e=t.props.dispatch;!t.state.status||t.state.id?t.state.status?e({type:"artificial/start",payload:t.state.id}):e({type:"artificial/stop"}):i["a"].warn("\u8bf7\u9009\u62e9\u5de1\u68c0\u8ba1\u5212")}},this.state.status?"\u5f00\u59cb":"\u7ec8\u6b62"))),m?T.a.createElement(_["a"],{visible:p,handleCancel:this.handleCancel,logInfo:m,fetchStream:h,deleteCallback:this.deleteEventLog}):null))}}])}(O["Component"]))||G)||G);e["default"]=nt},"0jGE":function(t,e,n){t.exports={rtcPlayer:"antd-pro-components-js-web-r-t-c-index-rtcPlayer"}},"4/k0":function(t,e,n){t.exports={container:"antd-pro-pages-monitor-artificial-index-container",blockView:"antd-pro-pages-monitor-artificial-index-blockView",playerCard:"antd-pro-pages-monitor-artificial-index-playerCard",closeIcon:"antd-pro-pages-monitor-artificial-index-closeIcon",emptyBlockView:"antd-pro-pages-monitor-artificial-index-emptyBlockView",header:"antd-pro-pages-monitor-artificial-index-header",theTitle:"antd-pro-pages-monitor-artificial-index-theTitle",personCenter:"antd-pro-pages-monitor-artificial-index-personCenter",image:"antd-pro-pages-monitor-artificial-index-image",name:"antd-pro-pages-monitor-artificial-index-name",exit:"antd-pro-pages-monitor-artificial-index-exit",block:"antd-pro-pages-monitor-artificial-index-block",rightBlock:"antd-pro-pages-monitor-artificial-index-rightBlock",underTable:"antd-pro-pages-monitor-artificial-index-underTable",videoEmpty:"antd-pro-pages-monitor-artificial-index-videoEmpty",download:"antd-pro-pages-monitor-artificial-index-download"}}}]);